# 需求文档

## 简介

本文档定义医院门诊预约挂号系统的用户认证模块需求，包括多角色用户（患者、医师、管理员）的实名制注册、登录认证、权限控制及个人信息管理功能。该模块是系统的基础设施，为其他业务功能提供身份验证和授权支持。

## 术语表

- **系统**: 医院门诊预约挂号系统
- **患者**: 使用系统进行预约挂号的普通用户
- **医师**: 提供医疗服务、管理预约的医护人员
- **管理员**: 负责系统配置和用户管理的后台管理人员
- **JWT**: JSON Web Token，用于用户身份认证的令牌机制
- **RBAC**: 基于角色的访问控制
- **BCrypt**: 密码加密算法

## 需求列表

### 需求 1

**用户故事:** 作为患者，我希望使用个人信息注册账户，以便使用预约挂号系统。

#### 验收标准

1. WHEN 患者提交包含有效姓名、身份证号、手机号、病史和过敏史的注册信息 THEN 系统 SHALL 创建新的患者账户并返回成功确认。
2. WHEN 患者提交的身份证号已存在于系统中 THEN 系统 SHALL 拒绝注册并显示身份证重复的错误信息。
3. WHEN 患者提交的手机号格式无效 THEN 系统 SHALL 拒绝注册并显示验证错误信息。
4. WHEN 患者提交的身份证号格式验证失败 THEN 系统 SHALL 拒绝注册并显示验证错误信息。
5. IF 患者提交的注册信息缺少必填字段 THEN 系统 SHALL 拒绝注册并高亮显示缺失的字段。

### 需求 2

**用户故事:** 作为医师，我希望使用专业资质信息注册账户，以便管理我的预约和患者咨询。

#### 验收标准

1. WHEN 医师提交包含有效姓名、工号、职称、科室、专长和医师资格证号的注册信息 THEN 系统 SHALL 创建待审批的医师账户。
2. WHEN 医师提交的工号已存在于系统中 THEN 系统 SHALL 拒绝注册并显示工号重复的错误信息。
3. WHEN 医师提交的医师资格证格式无效 THEN 系统 SHALL 拒绝注册并显示验证错误信息。
4. WHEN 管理员审批通过待审批的医师注册 THEN 系统 SHALL 激活医师账户并向医师发送通知。

### 需求 3

**用户故事:** 作为用户，我希望安全地登录系统，以便访问与我角色相应的功能。

#### 验收标准

1. WHEN 用户提交有效的凭证（手机号/工号和密码） THEN 系统 SHALL 验证用户身份并返回包含角色信息的 JWT 令牌。
2. WHEN 用户提交无效的凭证 THEN 系统 SHALL 拒绝登录尝试并显示认证错误信息。
3. WHEN 用户连续登录失败 5 次 THEN 系统 SHALL 锁定账户 30 分钟并显示锁定信息。
4. WHILE 用户会话处于活动状态 THE 系统 SHALL 在每个受保护的请求上验证 JWT 令牌。
5. WHEN JWT 令牌过期 THEN 系统 SHALL 拒绝请求并提示用户重新认证。

### 需求 4

**用户故事:** 作为用户，我希望管理我的个人信息，以便保持资料的最新状态。

#### 验收标准

1. WHEN 已认证用户请求其个人资料 THEN 系统 SHALL 根据用户角色返回相应的个人信息。
2. WHEN 已认证用户使用有效数据更新个人资料 THEN 系统 SHALL 保存更改并返回成功确认。
3. WHEN 已认证用户尝试更新受保护字段（身份证号、工号） THEN 系统 SHALL 拒绝更新并显示错误信息。
4. WHEN 用户使用正确的当前密码和有效的新密码请求修改密码 THEN 系统 SHALL 使用 BCrypt 加密更新密码。
5. IF 用户提交的新密码不符合强度要求（最少 8 个字符，包含字母和数字） THEN 系统 SHALL 拒绝修改并显示密码策略要求。

### 需求 5

**用户故事:** 作为系统管理员，我希望实现基于角色的访问控制，以便用户只能访问与其角色相应的功能。

#### 验收标准

1. WHEN 患者尝试访问仅限医师的接口 THEN 系统 SHALL 返回 403 禁止访问响应拒绝请求。
2. WHEN 医师尝试访问仅限管理员的接口 THEN 系统 SHALL 返回 403 禁止访问响应拒绝请求。
3. WHEN 管理员访问用户管理接口 THEN 系统 SHALL 允许请求并返回请求的数据。
4. WHILE 处理任何已认证的请求 THE 系统 SHALL 验证用户角色是否符合接口所需的权限。

### 需求 6

**用户故事:** 作为用户，我希望在忘记密码时能够找回密码，以便重新获得账户访问权限。

#### 验收标准

1. WHEN 用户使用已注册的手机号请求密码重置 THEN 系统 SHALL 生成验证码并通过短信发送。
2. WHEN 用户在 5 分钟内提交有效的验证码 THEN 系统 SHALL 允许用户设置新密码。
3. WHEN 用户提交过期或无效的验证码 THEN 系统 SHALL 拒绝请求并显示错误信息。
4. WHEN 用户成功重置密码 THEN 系统 SHALL 使该用户的所有现有会话失效。
