# 实现计划

- [x] 1. 搭建项目结构和核心依赖







  - [x] 1.1 初始化后端项目（Express/Node.js）



    - 创建后端目录结构（controllers、services、models、middlewares、routes）
    - 安装依赖：express、jsonwebtoken、bcrypt、mysql2、redis、uuid
    - 配置 TypeScript 和 ESLint
    - _需求: 1.1, 2.1, 3.1_
  - [x] 1.2 配置数据库连接和 ORM



    - 配置 MySQL 连接池
    - 配置 Redis 客户端用于会话/缓存管理
    - 创建数据库迁移脚本
    - _需求: 1.1, 2.1_

  - [x] 1.3 配置测试框架


    - 安装 Jest/Vitest 和 fast-check 用于属性测试
    - 配置测试环境和测试数据库
    - _需求: 全部_

- [x] 2. 实现数据库模式和模型



  - [x] 2.1 创建数据库表


    - 创建包含角色和状态字段的用户表
    - 创建包含个人和医疗信息的患者表
    - 创建包含专业资质的医师表
    - 创建管理员表
    - 在常用查询字段上添加索引
    - _需求: 1.1, 2.1_
  - [x] 2.2 实现 TypeScript 数据模型

    - 定义 User、Patient、Doctor、Admin 接口
    - 实现数据访问层（repositories）
    - _需求: 1.1, 2.1_

  - [x] 2.3 编写数据模型验证的属性测试

    - **属性 3: 无效输入验证**
    - **验证需求: 1.3, 1.4, 2.3**

- [x] 3. 实现验证工具


  - [x] 3.1 创建输入验证器
    - 实现手机号格式验证器（中国手机号: 1[3-9]XXXXXXXXX）
    - 实现身份证格式验证器（18位含校验码）
    - 实现医师资格证格式验证器
    - 实现密码强度验证器
    - _需求: 1.3, 1.4, 2.3, 4.5_


  - [x] 3.2 编写密码强度的属性测试

    - **属性 14: 密码强度验证**
    - **验证需求: 4.5**

- [x] 4. 实现患者注册


  - [x] 4.1 创建患者注册接口
    - 实现 POST /api/auth/register/patient
    - 验证所有必填字段
    - 检查手机号和身份证是否重复
    - 使用 BCrypt 加密密码
    - 在事务中创建用户和患者记录
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [x] 4.2 编写患者注册的属性测试

    - **属性 1: 有效患者注册创建账户**
    - **验证需求: 1.1**
  - [x] 4.3 编写重复拒绝的属性测试

    - **属性 2: 重复身份证拒绝**
    - **验证需求: 1.2**

  - [x] 4.4 编写必填字段的属性测试

    - **属性 4: 必填字段验证**
    - **验证需求: 1.5**

- [x] 5. 实现医师注册
  - [x] 5.1 创建医师注册接口
    - 实现 POST /api/auth/register/doctor
    - 验证所有必填字段包括资格证号
    - 检查工号和资格证是否重复
    - 创建用户（状态: pending）和医师记录
    - _需求: 2.1, 2.2, 2.3_
  - [x] 5.2 编写医师注册的属性测试
    - **属性 5: 医师注册创建待审批账户**
    - **验证需求: 2.1**

- [x] 6. 检查点 - 确保所有测试通过



  - 确保所有测试通过，如有问题请询问用户。

- [x] 7. 实现 JWT 认证

  - [x] 7.1 创建 JWT 服务

    - 实现包含用户 ID 和角色的令牌生成
    - 实现令牌验证
    - 配置令牌过期时间（访问令牌: 2小时，刷新令牌: 7天）
    - _需求: 3.1, 3.4, 3.5_

  - [x] 7.2 创建 JWT 中间件
    - 从 Authorization 头提取令牌
    - 验证令牌并将用户附加到请求
    - 处理过期/无效令牌

    - _需求: 3.4, 3.5_
  - [x] 7.3 编写 JWT 验证的属性测试


    - **属性 9: 受保护请求的 JWT 验证**
    - **验证需求: 3.4, 3.5**

- [x] 8. 实现用户登录


  - [x] 8.1 创建登录接口
    - 实现 POST /api/auth/login
    - 验证凭证与数据库匹配
    - 检查账户状态（active、pending、locked、disabled）
    - 生成并返回 JWT 令牌对

    - _需求: 3.1, 3.2_
  - [x] 8.2 实现登录失败追踪
    - 在 Redis 中追踪连续登录失败次数
    - 5 次失败后锁定账户 30 分钟
    - 登录成功后清除失败记录
    - _需求: 3.3_

  - [x] 8.3 编写登录的属性测试

    - **属性 7: 有效凭证返回包含正确角色的 JWT**
    - **验证需求: 3.1**

  - [x] 8.4 编写无效凭证的属性测试

    - **属性 8: 无效凭证拒绝**
    - **验证需求: 3.2**

- [x] 9. 实现 RBAC 中间件



  - [x] 9.1 创建基于角色的访问控制中间件

    - 实现 requireRole 中间件工厂
    - 检查用户角色是否在允许的角色列表中
    - 对未授权访问返回 403
    - _需求: 5.1, 5.2, 5.3, 5.4_

  - [x] 9.2 编写 RBAC 的属性测试

    - **属性 15: RBAC 权限验证**
    - **验证需求: 5.1, 5.2, 5.3, 5.4**

- [x] 10. 检查点 - 确保所有测试通过



  - 确保所有测试通过，如有问题请询问用户。

- [x] 11. 实现用户资料管理



  - [x] 11.1 创建资料接口

    - 实现 GET /api/users/profile
    - 实现 PUT /api/users/profile
    - 返回角色对应的资料数据
    - 阻止修改受保护字段
    - _需求: 4.1, 4.2, 4.3_

  - [x] 11.2 编写资料获取的属性测试

    - **属性 10: 资料获取返回角色对应数据**
    - **验证需求: 4.1**

  - [x] 11.3 编写资料更新的属性测试

    - **属性 11: 资料更新持久化**

    - **验证需求: 4.2**

  - [ ] 11.4 编写受保护字段的属性测试
    - **属性 12: 受保护字段不可修改**
    - **验证需求: 4.3**

- [x] 12. 实现密码管理


  - [x] 12.1 创建密码修改接口
    - 实现 PUT /api/users/password
    - 验证当前密码
    - 验证新密码强度
    - 更新密码哈希

    - _需求: 4.4, 4.5_
  - [x] 12.2 编写密码修改的属性测试


    - **属性 13: 密码修改往返测试**
    - **验证需求: 4.4**

- [x] 13. 实现密码重置流程


  - [x] 13.1 创建密码重置接口
    - 实现 POST /api/auth/reset-password/request（发送验证码）
    - 实现 POST /api/auth/reset-password/verify（验证验证码）
    - 实现 POST /api/auth/reset-password/confirm（设置新密码）
    - 在 Redis 中存储验证码，TTL 为 5 分钟
    - 重置成功后使所有用户会话失效

    - _需求: 6.1, 6.2, 6.3, 6.4_

  - [x] 13.2 编写验证码的属性测试
    - **属性 16: 验证码有效性**

    - **验证需求: 6.1, 6.2, 6.3**
  - [x] 13.3 编写会话失效的属性测试

    - **属性 17: 密码重置使会话失效**
    - **验证需求: 6.4**

- [x] 14. 实现管理员审批医师



  - [x] 14.1 创建管理员审批接口

    - 实现 PUT /api/admin/doctors/:id/approve
    - 更新医师账户状态为 active
    - 记录审批时间和审批人
    - _需求: 2.4_

  - [x] 14.2 编写医师审批的属性测试

    - **属性 6: 医师审批激活账户**
    - **验证需求: 2.4**



- [ ] 15. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。
