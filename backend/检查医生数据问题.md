# 检查医生数据问题

## 问题

点击检查项目后显示"0位医生可用"，但数据库表中有关联数据。

## 可能的原因

### 1. 对应科室没有医生

检查项目关联的科室可能没有医生数据。根据关联关系：
- item-001 (健康体检) → dpt-001 (心血管内科), dpt-003 (皮肤科)
- item-002 (皮肤检查) → dpt-003 (皮肤科)
- item-003 (口腔检查) → dpt-006 (口腔科) ⚠️ **可能没有医生**
- item-004 (眼科检查) → dpt-005 (眼科)
- item-005 (妇科检查) → dpt-007 (妇科) ⚠️ **可能没有医生**

### 2. 医生状态不是 ACTIVE

医生可能处于 PENDING 或其他状态，没有被查询出来。

## 诊断步骤

### 步骤1：检查各科室的医生数量

在 Navicat 中执行：

```sql
-- 检查各科室的医生数量
SELECT 
    d.id,
    d.name as 科室名称,
    COUNT(doc.id) as 医生数量
FROM departments d
LEFT JOIN doctors doc ON d.id = doc.department_id
GROUP BY d.id, d.name
ORDER BY d.id;
```

### 步骤2：检查检查项目关联的科室是否有医生

```sql
-- 检查每个检查项目关联的科室是否有医生
SELECT 
    ei.id as 检查项目ID,
    ei.name as 检查项目名称,
    d.id as 科室ID,
    d.name as 科室名称,
    COUNT(doc.id) as 该科室医生数量
FROM examination_items ei
LEFT JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
LEFT JOIN departments d ON eid.department_id = d.id
LEFT JOIN doctors doc ON d.id = doc.department_id
WHERE ei.enabled = 1
GROUP BY ei.id, ei.name, d.id, d.name
ORDER BY ei.id, d.id;
```

### 步骤3：检查医生状态

```sql
-- 检查医生状态
SELECT 
    doc.id,
    doc.name,
    doc.department_id,
    d.name as 科室名称,
    u.status as 用户状态
FROM doctors doc
LEFT JOIN departments d ON doc.department_id = d.id
LEFT JOIN users u ON doc.user_id = u.id
ORDER BY doc.department_id;
```

## 解决方案

### 方案1：为缺失的科室添加医生

如果口腔科（dpt-006）和妇科（dpt-007）没有医生，需要添加：

```sql
-- 添加口腔科医生（示例）
-- 首先需要添加用户
INSERT IGNORE INTO users (id, phone, password_hash, role, status) VALUES
('usr-doc-006', '13800000006', '$2a$10$f/3Jc.M29s29x2/oiMD.S.V731wV1b.H/d8H9d7E2dG0f0jG3jS.q', 'DOCTOR', 'ACTIVE');

-- 添加医生
INSERT IGNORE INTO doctors (id, user_id, name, employee_id, title, department_id, specialty, license_number, introduction, approved_at, approved_by) VALUES
('doc-006', 'usr-doc-006', '口腔科医生', 'D0006', 'ATTENDING', 'dpt-006', '口腔疾病诊治', 'LIC20230006', '专业口腔科医生', NOW(), 'adm-001');

-- 添加妇科医生（示例）
INSERT IGNORE INTO users (id, phone, password_hash, role, status) VALUES
('usr-doc-007', '13800000007', '$2a$10$f/3Jc.M29s29x2/oiMD.S.V731wV1b.H/d8H9d7E2dG0f0jG3jS.q', 'DOCTOR', 'ACTIVE');

INSERT IGNORE INTO doctors (id, user_id, name, employee_id, title, department_id, specialty, license_number, introduction, approved_at, approved_by) VALUES
('doc-007', 'usr-doc-007', '妇科医生', 'D0007', 'ATTENDING', 'dpt-007', '妇科疾病诊治', 'LIC20230007', '专业妇科医生', NOW(), 'adm-001');
```

### 方案2：检查后端日志

查看后端启动日志，搜索：
- "Found X departments for medical item"
- "Found X doctors across X departments"

如果看到 "Found 0 doctors"，说明对应科室确实没有医生。

### 方案3：测试后端API

直接调用后端API测试：

```bash
# 测试搜索医生（使用健康体检 item-001）
GET http://localhost:8080/api/doctors/search?medicalItemId=item-001
```

查看返回的医生数量。

## 快速验证

执行以下SQL快速检查：

```sql
-- 快速检查：每个检查项目能查到多少医生
SELECT 
    ei.name as 检查项目,
    COUNT(DISTINCT doc.id) as 可用医生数
FROM examination_items ei
LEFT JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
LEFT JOIN departments d ON eid.department_id = d.id
LEFT JOIN doctors doc ON d.id = doc.department_id
LEFT JOIN users u ON doc.user_id = u.id
WHERE ei.enabled = 1 
  AND u.status = 'ACTIVE'  -- 只统计激活状态的医生
GROUP BY ei.id, ei.name
ORDER BY ei.id;
```

如果某个检查项目显示0，说明对应科室没有激活的医生。

## 常见问题

1. **口腔科和妇科没有医生**：这是最可能的原因，因为这两个科室是新添加的
2. **医生状态不是ACTIVE**：检查 `users` 表中医生的 `status` 字段
3. **医生没有审批**：检查 `doctors` 表中 `approved_at` 是否为 NULL

