# 检查项目数据迁移说明

## 问题描述

原来的设计将 `examination_items` 表理解为具体的检查项目（如"血常规"、"尿常规"等），但实际上应该用于存储**健康检查推荐项目**（如"年度体检"、"皮肤检查"等），用于筛选医生。

## 解决方案

通过最小改动实现：
1. 创建关联表 `examination_item_departments`，实现检查项目与科室的多对多关系
2. 修改后端代码，支持通过检查项目ID查询关联科室的医生
3. 更新数据库数据，将具体检查项目改为健康检查推荐项目

## 执行步骤

### 步骤1：创建关联表

在 Navicat 中执行以下 SQL 脚本：

```sql
-- 文件：02_create_examination_item_departments.sql
```

或者直接执行：

```sql
CREATE TABLE IF NOT EXISTS examination_item_departments (
    id VARCHAR(36) PRIMARY KEY COMMENT '关联ID (UUID)',
    examination_item_id VARCHAR(36) NOT NULL COMMENT '检查项目ID',
    department_id VARCHAR(36) NOT NULL COMMENT '科室ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (examination_item_id) REFERENCES examination_items(id) ON DELETE CASCADE,
    FOREIGN KEY (department_id) REFERENCES departments(id) ON DELETE CASCADE,
    UNIQUE KEY uk_item_dept (examination_item_id, department_id),
    INDEX idx_examination_item_id (examination_item_id),
    INDEX idx_department_id (department_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='检查项目与科室关联表';
```

### 步骤2：备份现有数据（可选但强烈建议）

```sql
-- 备份检查项目表
CREATE TABLE examination_items_backup AS SELECT * FROM examination_items;

-- 如果关联表已存在，也备份
CREATE TABLE examination_item_departments_backup AS SELECT * FROM examination_item_departments;
```

### 步骤3：更新数据

在 Navicat 中执行以下 SQL 脚本：

```sql
-- 文件：03_update_examination_items_data.sql
```

这个脚本会：
1. 清空现有的检查项目数据
2. 插入新的健康检查推荐项目（年度体检、皮肤检查、牙齿清洁、眼科检查、年度妇科检查）
3. 建立检查项目与科室的关联关系

**注意**：如果您的医院有口腔科、妇科等科室，请根据实际情况修改脚本中的关联关系。

### 步骤4：验证数据

执行以下查询验证数据是否正确：

```sql
-- 查看检查项目及其关联的科室
SELECT 
    ei.id, 
    ei.name, 
    ei.description, 
    ei.category, 
    GROUP_CONCAT(d.name) as departments
FROM examination_items ei
LEFT JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
LEFT JOIN departments d ON eid.department_id = d.id
WHERE ei.enabled = 1
GROUP BY ei.id, ei.name, ei.description, ei.category;
```

## 数据说明

### 健康检查推荐项目

根据界面设计，包含以下项目：

1. **年度体检** (`item-001`)
   - 描述：CDC建议每年进行一次常规体检，及早发现健康问题
   - 关联科室：心血管内科、皮肤科（可根据实际情况调整）

2. **皮肤检查** (`item-002`)
   - 描述：根据美国癌症协会的建议，预防和早期发现是抗击癌症的第一步
   - 关联科室：皮肤科

3. **牙齿清洁** (`item-003`)
   - 描述：美国牙科协会建议定期清洁以预防牙龈疾病
   - 关联科室：口腔科（如果医院有，请在脚本中添加）

4. **眼科检查** (`item-004`)
   - 描述：美国眼科学会建议佩戴隐形眼镜的患者每年进行视力筛查
   - 关联科室：眼科

5. **年度妇科检查** (`item-005`)
   - 描述：美国妇产科学会建议即使不需要进行宫颈癌筛查，也应每年看一次妇科医生
   - 关联科室：妇科（如果医院有，请在脚本中添加）

## 代码改动说明

### 后端改动

1. **新增实体类**：`ExaminationItemDepartment.java`
   - 表示检查项目与科室的关联关系

2. **新增Repository**：`ExaminationItemDepartmentRepository.java`
   - 提供查询关联关系的方法

3. **修改DTO**：`DoctorSearchDTO.java`
   - 添加 `medicalItemId` 字段

4. **修改Controller**：`DoctorController.java`
   - 在 `searchDoctors` 方法中添加 `medicalItemId` 参数

5. **修改Service**：`DoctorProfileService.java`
   - 在 `searchDoctors` 方法中支持通过 `medicalItemId` 查询关联科室的医生

### 前端改动

前端代码已经支持 `medicalItemId` 参数，无需修改。

## 使用流程

1. 用户在"热门检查项目"页面选择检查项目（如"年度体检"）
2. 点击"预约"按钮，跳转到搜索结果页面
3. 后端根据检查项目ID查询关联的科室
4. 显示这些科室的医生列表
5. 用户可以选择医生进行预约

## 注意事项

1. **数据备份**：执行更新脚本前，请务必备份现有数据
2. **预约数据**：如果已有预约数据关联了旧的检查项目，需要先处理这些数据
3. **科室关联**：根据医院实际情况，调整检查项目与科室的关联关系
4. **价格字段**：健康检查推荐项目的价格设为 0.00，因为这是用于筛选医生的，不是具体的收费项目

## 后续扩展

如果需要添加新的健康检查推荐项目：

1. 在 `examination_items` 表中插入新记录
2. 在 `examination_item_departments` 表中建立与科室的关联关系

示例：

```sql
-- 添加新项目
INSERT INTO examination_items (id, name, description, price, category, enabled, created_at) 
VALUES ('item-006', '心脏检查', '定期检查心脏健康', 0.00, '专科检查', 1, NOW());

-- 关联科室
INSERT INTO examination_item_departments (id, examination_item_id, department_id, created_at) 
VALUES (UUID(), 'item-006', 'dpt-001', NOW()); -- 关联心血管内科
```

