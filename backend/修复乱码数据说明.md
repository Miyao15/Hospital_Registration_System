# 修复乱码数据说明

## 问题

`encoding: UTF-8` 配置只能确保**新插入**的数据使用正确的编码，但**已经存在的乱码数据不会自动修复**。

## 解决方案

### 方案1：使用修复脚本（推荐）

已创建修复脚本：`05_fix_chinese_encoding.sql`

**执行步骤：**

1. **在 Navicat 中打开查询窗口**
2. **执行修复脚本**：
   ```sql
   -- 执行文件：05_fix_chinese_encoding.sql
   ```
3. **验证结果**：
   ```sql
   SELECT id, name, description FROM departments ORDER BY sort_order;
   ```

**脚本说明：**
- 使用 `INSERT ... ON DUPLICATE KEY UPDATE` 语法
- 如果数据已存在，会更新为正确的中文
- 如果数据不存在，会插入新数据
- **安全**：不会删除现有数据，只是更新字段

### 方案2：手动更新（如果脚本不适用）

如果某些表的数据需要特殊处理，可以手动执行：

```sql
-- 更新单个科室
UPDATE departments 
SET name = '口腔科', 
    description = '诊治口腔、牙齿、牙龈及相关疾病的专科。'
WHERE id = 'dpt-006';

-- 更新多个科室
UPDATE departments 
SET name = CASE id
    WHEN 'dpt-001' THEN '心血管内科'
    WHEN 'dpt-002' THEN '骨科'
    WHEN 'dpt-003' THEN '皮肤科'
    -- ... 更多
END,
description = CASE id
    WHEN 'dpt-001' THEN '专注于心血管系统疾病的诊断和治疗，如高血压、冠心病等。'
    WHEN 'dpt-002' THEN '处理骨骼、关节、韧带、肌腱和肌肉的损伤和疾病。'
    -- ... 更多
END
WHERE id IN ('dpt-001', 'dpt-002', 'dpt-003', ...);
```

### 方案3：删除后重新插入（谨慎使用）

如果数据不重要，可以删除后让应用重新插入：

```sql
-- 删除乱码数据
DELETE FROM departments WHERE id IN ('dpt-006', 'dpt-007');

-- 重启应用，让 01_add_examination_items.sql 重新插入（现在已修复编码）
```

## 重要提示

### ⚠️ 不要将修复脚本放在 data-locations 中

修复脚本 `05_fix_chinese_encoding.sql` **不要**放在 `application.yml` 的 `data-locations` 中，因为：
- 它使用 `ON DUPLICATE KEY UPDATE`，每次启动都会执行更新
- 虽然不会报错，但会不必要地更新数据

**正确的做法：**
- 只在需要时手动执行一次
- 或者放在单独的修复脚本目录中

### ✅ 配置已修复

`application.yml` 中已添加 `encoding: UTF-8`，所以：
- **新插入的数据**：会自动使用 UTF-8 编码，不会乱码
- **已存在的数据**：需要手动执行修复脚本

## 执行顺序

1. **修复配置**（已完成）
   - `application.yml` 中添加 `encoding: UTF-8`

2. **修复已存在的数据**（需要手动执行）
   - 在 Navicat 中执行 `05_fix_chinese_encoding.sql`

3. **验证**
   ```sql
   SELECT * FROM departments WHERE id IN ('dpt-006', 'dpt-007');
   ```

4. **重启应用**
   - 确保新配置生效
   - 之后插入的数据都会使用正确的编码

## 检查哪些表有乱码

执行以下查询检查各个表的中文数据：

```sql
-- 检查科室表
SELECT id, name, description FROM departments;

-- 检查用户表（如果有中文）
SELECT id, name FROM admins;
SELECT id, name FROM doctors;
SELECT id, name FROM patients;

-- 检查检查项目表
SELECT id, name, description FROM examination_items;

-- 检查通知表
SELECT id, title, content FROM notifications WHERE content LIKE '%预约%' OR content LIKE '%医生%';
```

## 预防措施

1. ✅ **配置已修复**：`encoding: UTF-8`
2. ✅ **SQL 文件编码**：确保所有 SQL 文件都是 UTF-8 编码
3. ✅ **数据库字符集**：使用 `utf8mb4`
4. ✅ **连接字符串**：包含 `useUnicode=true&characterEncoding=UTF-8`

## 总结

- **新数据**：配置修复后，自动使用 UTF-8，不会乱码 ✅
- **旧数据**：需要手动执行修复脚本修复乱码 ⚠️
- **修复脚本**：`05_fix_chinese_encoding.sql`（手动执行，不要放在自动执行列表中）

