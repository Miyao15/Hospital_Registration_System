# 检查关联关系问题 - 显示0位医生

## 问题诊断

点击检查项目后显示0位医生可用，可能的原因：

1. **关联关系没有正确建立**
2. **对应科室没有医生**
3. **后端查询逻辑有问题**
4. **前端没有正确传递参数**

## 诊断步骤

### 步骤1：检查关联关系是否存在

在 Navicat 中执行：

```sql
-- 检查 examination_item_departments 表中是否有数据
SELECT * FROM examination_item_departments;

-- 检查每个检查项目关联了哪些科室
SELECT 
    ei.id as 检查项目ID,
    ei.name as 检查项目名称,
    eid.department_id as 科室ID,
    d.name as 科室名称
FROM examination_items ei
LEFT JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
LEFT JOIN departments d ON eid.department_id = d.id
WHERE ei.enabled = 1
ORDER BY ei.id, d.name;
```

**预期结果：** 应该看到每个检查项目都关联了对应的科室。

如果结果为空，说明关联关系没有建立，需要执行更新脚本。

### 步骤2：检查科室是否有医生

```sql
-- 检查每个科室的医生数量
SELECT 
    d.id as 科室ID,
    d.name as 科室名称,
    COUNT(doc.id) as 医生数量
FROM departments d
LEFT JOIN doctors doc ON d.id = doc.department_id
WHERE d.enabled = 1
GROUP BY d.id, d.name
ORDER BY d.id;
```

**预期结果：** 应该看到每个科室都有医生。

如果某些科室显示0位医生，需要添加对应科室的医生。

### 步骤3：检查具体检查项目关联的科室是否有医生

```sql
-- 检查"健康体检"关联的科室是否有医生
SELECT 
    ei.name as 检查项目,
    d.name as 科室,
    COUNT(doc.id) as 医生数量
FROM examination_items ei
JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
JOIN departments d ON eid.department_id = d.id
LEFT JOIN doctors doc ON d.id = doc.department_id
WHERE ei.id = 'item-001'  -- 健康体检
GROUP BY ei.name, d.name;
```

### 步骤4：检查后端日志

查看后端控制台日志，应该能看到类似这样的日志：

```
Searching doctors with departmentId: null, keyword: null, medicalItemId: item-001
Found 2 departments for medical item item-001
Found 3 doctors across 2 departments
```

如果日志显示 `Found 0 departments`，说明关联关系没有建立。

如果日志显示 `Found X departments` 但 `Found 0 doctors`，说明对应科室没有医生。

## 解决方案

### 方案1：如果关联关系没有建立

重新执行更新脚本：

```sql
-- 清空关联关系
DELETE FROM examination_item_departments WHERE 1=1;

-- 重新建立关联关系
INSERT INTO examination_item_departments (id, examination_item_id, department_id, created_at) VALUES
(UUID(), 'item-001', 'dpt-001', NOW()), -- 健康体检 -> 心血管内科
(UUID(), 'item-001', 'dpt-003', NOW()), -- 健康体检 -> 皮肤科
(UUID(), 'item-002', 'dpt-003', NOW()), -- 皮肤检查 -> 皮肤科
(UUID(), 'item-003', 'dpt-006', NOW()), -- 口腔检查 -> 口腔科
(UUID(), 'item-004', 'dpt-005', NOW()), -- 眼科检查 -> 眼科
(UUID(), 'item-005', 'dpt-007', NOW()); -- 妇科检查 -> 妇科
```

### 方案2：如果科室没有医生

需要添加对应科室的医生。检查当前有哪些医生：

```sql
-- 查看所有医生及其科室
SELECT 
    doc.id,
    doc.name as 医生姓名,
    doc.department_id,
    d.name as 科室名称
FROM doctors doc
LEFT JOIN departments d ON doc.department_id = d.id
ORDER BY d.name, doc.name;
```

如果某个科室没有医生，需要：
1. 添加该科室的医生（通过管理员后台或直接插入数据库）
2. 或者修改关联关系，关联到有医生的科室

### 方案3：如果医生状态不正确

检查医生是否被启用：

```sql
-- 检查医生及其用户状态
SELECT 
    doc.id,
    doc.name as 医生姓名,
    d.name as 科室,
    u.status as 用户状态
FROM doctors doc
LEFT JOIN departments d ON doc.department_id = d.id
LEFT JOIN users u ON doc.user_id = u.id
WHERE doc.department_id IN ('dpt-001', 'dpt-003', 'dpt-005', 'dpt-006', 'dpt-007')
ORDER BY d.name;
```

确保医生的用户状态是 `ACTIVE`。

## 快速测试查询

执行以下完整查询，一次性检查所有问题：

```sql
-- 完整检查：检查项目 -> 科室 -> 医生
SELECT 
    ei.id as 检查项目ID,
    ei.name as 检查项目,
    d.id as 科室ID,
    d.name as 科室,
    COUNT(DISTINCT doc.id) as 医生数量,
    GROUP_CONCAT(DISTINCT doc.name) as 医生列表
FROM examination_items ei
LEFT JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
LEFT JOIN departments d ON eid.department_id = d.id
LEFT JOIN doctors doc ON d.id = doc.department_id
LEFT JOIN users u ON doc.user_id = u.id AND u.status = 'ACTIVE'
WHERE ei.enabled = 1
GROUP BY ei.id, ei.name, d.id, d.name
ORDER BY ei.id, d.name;
```

**预期结果：** 每个检查项目应该显示关联的科室和每个科室的医生数量。

如果某个检查项目的所有科室都显示0位医生，需要添加对应科室的医生。

