# 配置修改说明

## ✅ 已修改配置

已将 `application.yml` 中的 SQL 初始化模式从 `never` 改为 `always`，这样 Spring Boot 启动时会自动执行 SQL 脚本。

### 修改内容

**之前：**
```yaml
spring:
  sql:
    init:
      mode: never  # 不自动执行
      schema-locations: classpath:schema.sql
      data-locations: []
```

**现在：**
```yaml
spring:
  sql:
    init:
      mode: always  # 每次启动时自动执行
      schema-locations: classpath:schema.sql
      data-locations: 
        - classpath:01_add_examination_items.sql  # 初始化数据脚本
```

---

## 🔍 工作原理

### 1. Schema 脚本（`schema.sql`）
- **执行时机**：每次应用启动时
- **作用**：创建表结构
- **安全性**：使用 `CREATE TABLE IF NOT EXISTS`，如果表已存在则跳过
- **包含内容**：
  - 所有基础表（users, doctors, departments 等）
  - `examination_items` 表
  - `examination_item_departments` 表（新增）

### 2. Data 脚本（`01_add_examination_items.sql`）
- **执行时机**：每次应用启动时（在 schema 之后）
- **作用**：插入初始数据
- **安全性**：使用 `INSERT ... WHERE NOT EXISTS` 或 `INSERT IGNORE` 避免重复
- **包含内容**：
  - 科室数据（包括新增的口腔科和妇科）
  - 用户数据
  - 医生数据
  - 其他初始数据

---

## ⚠️ 注意事项

### 1. 数据重复问题

如果数据库已经有数据，`01_add_examination_items.sql` 中的 INSERT 语句可能会：
- ✅ **安全**：如果使用 `WHERE NOT EXISTS` 或 `INSERT IGNORE`，不会重复插入
- ⚠️ **可能出错**：如果使用普通 `INSERT` 且数据已存在，会报错（但不影响表结构）

### 2. 检查项目数据

`01_add_examination_items.sql` 中插入的是**具体检查项目**（血常规、尿常规等），不是健康检查推荐项目。

如果需要插入健康检查推荐项目，需要：
1. 手动执行 `03_update_examination_items_data.sql`（一次性）
2. 或者修改 `01_add_examination_items.sql`，将检查项目部分改为健康检查推荐项目

### 3. 启动时间

每次启动都会执行 SQL 脚本，可能会稍微增加启动时间（通常几秒内）。

---

## 🚀 使用方式

### 方式1：完全自动（推荐用于开发环境）

1. **重启应用**
   ```bash
   # 停止应用
   # 重新启动 Spring Boot 应用
   ```

2. **自动执行**
   - Spring Boot 启动时会自动执行 `schema.sql` 创建表
   - 然后执行 `01_add_examination_items.sql` 插入数据

3. **验证**
   - 检查 `examination_item_departments` 表是否已创建
   - 检查科室表中是否有 7 个科室

### 方式2：手动执行更新脚本（推荐用于已有数据的系统）

如果您的数据库已经有数据，建议：

1. **保持自动执行 schema.sql**（创建表结构）
2. **手动执行数据更新脚本**：
   ```sql
   -- 在 Navicat 中执行
   -- 1. 04_add_missing_departments.sql（添加科室）
   -- 2. 03_update_examination_items_data.sql（更新检查项目）
   ```

---

## 🔧 如果需要禁用自动执行

如果以后想改回手动执行，只需修改配置：

```yaml
spring:
  sql:
    init:
      mode: never  # 改回 never
```

---

## 📝 建议的完整方案

### 开发环境（推荐使用自动执行）

保持当前配置（`mode: always`），每次启动自动创建表结构。

### 生产环境（推荐手动管理）

1. **改为 `mode: never`**
2. **手动执行 SQL 脚本**（通过数据库管理工具）
3. **更好的控制**：可以精确控制何时执行、执行哪些脚本

---

## ✅ 当前配置的优势

1. **自动创建表**：新表（如 `examination_item_departments`）会自动创建
2. **无需手动操作**：启动应用即可，不需要在 Navicat 中手动执行
3. **安全性**：使用 `IF NOT EXISTS` 确保不会重复创建

---

## 🎯 下一步

1. **重启应用**，让配置生效
2. **检查日志**，确认 SQL 脚本是否执行成功
3. **验证数据库**，确认新表已创建

如果遇到问题，可以查看启动日志中的 SQL 执行信息。

