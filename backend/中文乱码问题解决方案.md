# 中文乱码问题解决方案

## 问题描述

通过 Spring Boot 自动执行的 SQL 脚本插入的中文出现乱码，但在 Navicat 中手动执行相同的 SQL 语句则正常显示。

## 问题原因

Spring Boot 在执行 SQL 脚本时，默认可能使用系统编码（Windows 通常是 GBK），而不是 UTF-8，导致中文字符编码错误。

## 解决方案

### 方案1：在 application.yml 中指定编码（已修复）

已在 `application.yml` 中添加了 `encoding: UTF-8`：

```yaml
spring:
  sql:
    init:
      mode: always
      encoding: UTF-8  # 明确指定 SQL 脚本文件的字符编码为 UTF-8
      schema-locations: classpath:schema.sql
      data-locations: 
        - classpath:01_add_examination_items.sql
```

### 方案2：确保数据库连接编码正确（已配置）

数据库连接字符串已包含编码参数：

```yaml
url: jdbc:mysql://127.0.0.1:3306/hospital_registration?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&useUnicode=true&characterEncoding=UTF-8
```

### 方案3：确保数据库和表的字符集正确（已配置）

所有表都使用了 `utf8mb4` 字符集：

```sql
ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
```

## 验证步骤

### 1. 重启应用

修改配置后，重启 Spring Boot 应用。

### 2. 检查数据库

在 Navicat 中执行：

```sql
-- 检查数据库字符集
SHOW CREATE DATABASE hospital_registration;

-- 检查表的字符集
SHOW CREATE TABLE departments;

-- 检查数据是否正确
SELECT * FROM departments WHERE id IN ('dpt-006', 'dpt-007');
```

### 3. 如果仍有乱码

#### 方法A：检查 SQL 文件编码

确保 SQL 文件本身是 UTF-8 编码：

1. 在 IDE 中打开 `01_add_examination_items.sql`
2. 检查文件编码（VS Code: 右下角显示编码）
3. 如果不是 UTF-8，转换为 UTF-8：
   - VS Code: 点击右下角编码 → "通过编码保存" → 选择 "UTF-8"
   - IntelliJ IDEA: File → File Encoding → 选择 UTF-8

#### 方法B：在数据库连接 URL 中添加参数

如果方案1不起作用，可以尝试在连接 URL 中添加更多参数：

```yaml
url: jdbc:mysql://127.0.0.1:3306/hospital_registration?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&useUnicode=true&characterEncoding=UTF-8&connectionCollation=utf8mb4_unicode_ci
```

#### 方法C：设置数据库默认字符集

在 MySQL 中执行：

```sql
-- 设置数据库默认字符集
ALTER DATABASE hospital_registration CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 对于已有表，修改字符集
ALTER TABLE departments CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## 为什么 Navicat 中执行正常？

Navicat 在连接数据库时：
1. 默认使用 UTF-8 编码读取 SQL 文件
2. 或者根据文件 BOM（字节顺序标记）自动识别编码
3. 连接时已经设置了正确的字符集

而 Spring Boot 需要明确配置才能正确识别文件编码。

## 完整检查清单

- [x] `application.yml` 中添加 `encoding: UTF-8`
- [x] 数据库连接 URL 包含 `useUnicode=true&characterEncoding=UTF-8`
- [x] 表使用 `utf8mb4` 字符集
- [ ] SQL 文件本身是 UTF-8 编码（需要手动检查）
- [ ] 数据库默认字符集是 `utf8mb4`（可选）

## 如果问题仍然存在

1. **检查 SQL 文件编码**：确保文件是 UTF-8（无 BOM）
2. **检查数据库字符集**：执行 `SHOW VARIABLES LIKE 'character%';`
3. **检查表的字符集**：执行 `SHOW CREATE TABLE departments;`
4. **查看应用启动日志**：检查是否有编码相关的警告

## 测试

重启应用后，检查新插入的数据：

```sql
SELECT id, name, description FROM departments WHERE id IN ('dpt-006', 'dpt-007');
```

如果显示正常的中文，说明问题已解决。

