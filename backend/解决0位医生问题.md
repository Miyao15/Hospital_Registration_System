# 解决"0位医生可用"问题

## 问题原因

点击检查项目后显示"0位医生可用"，主要原因是：

1. **口腔科（dpt-006）和妇科（dpt-007）没有医生**
   - 这两个科室是新添加的
   - 初始数据中只有5个医生，分别属于：
     - doc-001: 心血管内科 (dpt-001) ✓
     - doc-002: 骨科 (dpt-002)
     - doc-003: 皮肤科 (dpt-003) ✓
     - doc-004: 儿科 (dpt-004)
     - doc-005: 眼科 (dpt-005) ✓

2. **检查项目关联的科室：**
   - item-001 (健康体检) → dpt-001, dpt-003 → **有医生** ✓
   - item-002 (皮肤检查) → dpt-003 → **有医生** ✓
   - item-003 (口腔检查) → dpt-006 → **没有医生** ❌
   - item-004 (眼科检查) → dpt-005 → **有医生** ✓
   - item-005 (妇科检查) → dpt-007 → **没有医生** ❌

## 解决方案

### 步骤1：在 Navicat 中执行添加医生脚本

执行文件：`06_add_missing_doctors.sql`

**或者直接执行以下 SQL：**

```sql
-- 添加口腔科医生
INSERT IGNORE INTO users (id, phone, password_hash, role, status) VALUES
('usr-doc-006', '13800000006', '$2a$10$f/3Jc.M29s29x2/oiMD.S.V731wV1b.H/d8H9d7E2dG0f0jG3jS.q', 'DOCTOR', 'ACTIVE');

INSERT IGNORE INTO doctors (id, user_id, name, employee_id, title, department_id, specialty, license_number, introduction, approved_at, approved_by) VALUES
('doc-006', 'usr-doc-006', '口腔科医生', 'D0006', 'ATTENDING', 'dpt-006', '口腔疾病诊治、牙齿修复', 'LIC20230006', '专业口腔科医生，擅长口腔疾病诊治和牙齿修复。', NOW(), 'adm-001');

-- 添加妇科医生
INSERT IGNORE INTO users (id, phone, password_hash, role, status) VALUES
('usr-doc-007', '13800000007', '$2a$10$f/3Jc.M29s29x2/oiMD.S.V731wV1b.H/d8H9d7E2dG0f0jG3jS.q', 'DOCTOR', 'ACTIVE');

INSERT IGNORE INTO doctors (id, user_id, name, employee_id, title, department_id, specialty, license_number, introduction, approved_at, approved_by) VALUES
('doc-007', 'usr-doc-007', '妇科医生', 'D0007', 'ATTENDING', 'dpt-007', '妇科疾病诊治、妇科常规检查', 'LIC20230007', '专业妇科医生，擅长妇科疾病诊治和常规检查。', NOW(), 'adm-001');
```

### 步骤2：验证数据

执行以下查询验证：

```sql
-- 检查各科室的医生数量
SELECT 
    d.id,
    d.name as 科室名称,
    COUNT(doc.id) as 医生数量,
    GROUP_CONCAT(doc.name) as 医生姓名
FROM departments d
LEFT JOIN doctors doc ON d.id = doc.department_id
WHERE d.id IN ('dpt-001', 'dpt-003', 'dpt-005', 'dpt-006', 'dpt-007')
GROUP BY d.id, d.name
ORDER BY d.id;
```

**预期结果：**

| 科室ID | 科室名称 | 医生数量 | 医生姓名 |
|---|---|---|---|
| dpt-001 | 心血管内科 | 1 | 李医生 |
| dpt-003 | 皮肤科 | 1 | 王医生 |
| dpt-005 | 眼科 | 1 | 陈医生 |
| dpt-006 | 口腔科 | 1 | 口腔科医生 |
| dpt-007 | 妇科 | 1 | 妇科医生 |

### 步骤3：检查每个检查项目的可用医生数

```sql
-- 检查每个检查项目能查到多少医生
SELECT 
    ei.id,
    ei.name as 检查项目,
    COUNT(DISTINCT doc.id) as 可用医生数,
    GROUP_CONCAT(DISTINCT CONCAT(d.name, ':', doc.name)) as 科室和医生
FROM examination_items ei
LEFT JOIN examination_item_departments eid ON ei.id = eid.examination_item_id
LEFT JOIN departments d ON eid.department_id = d.id
LEFT JOIN doctors doc ON d.id = doc.department_id
LEFT JOIN users u ON doc.user_id = u.id
WHERE ei.enabled = 1 
  AND (u.status = 'ACTIVE' OR u.status IS NULL)
GROUP BY ei.id, ei.name
ORDER BY ei.id;
```

**预期结果：**

| 检查项目ID | 检查项目 | 可用医生数 | 科室和医生 |
|---|---|---|---|
| item-001 | 健康体检 | 2 | 心血管内科:李医生,皮肤科:王医生 |
| item-002 | 皮肤检查 | 1 | 皮肤科:王医生 |
| item-003 | 口腔检查 | 1 | 口腔科:口腔科医生 |
| item-004 | 眼科检查 | 1 | 眼科:陈医生 |
| item-005 | 妇科检查 | 1 | 妇科:妇科医生 |

### 步骤4：刷新前端页面

1. 清除浏览器缓存（按 Ctrl+F5）
2. 重新点击检查项目
3. 应该能看到对应的医生了

## 如果仍然显示0位医生

### 检查1：医生状态

```sql
-- 检查医生及其用户状态
SELECT 
    doc.id,
    doc.name as 医生姓名,
    doc.department_id,
    d.name as 科室名称,
    u.status as 用户状态,
    doc.approved_at as 审批时间
FROM doctors doc
LEFT JOIN departments d ON doc.department_id = d.id
LEFT JOIN users u ON doc.user_id = u.id
WHERE doc.department_id IN ('dpt-001', 'dpt-003', 'dpt-005', 'dpt-006', 'dpt-007')
ORDER BY doc.department_id;
```

确保：
- `u.status = 'ACTIVE'`
- `doc.approved_at IS NOT NULL`（已审批）

### 检查2：后端日志

查看后端启动日志，搜索：
```
Found X departments for medical item item-001
Found X doctors across X departments
```

如果看到 "Found 0 doctors"，说明查询逻辑有问题。

### 检查3：直接测试API

在浏览器或 Postman 中测试：

```
GET http://localhost:8080/api/doctors/search?medicalItemId=item-001
```

查看返回的医生数量。

## 总结

执行 `06_add_missing_doctors.sql` 脚本后：
- ✅ 口腔科会有1位医生
- ✅ 妇科会有1位医生
- ✅ 所有检查项目都能找到对应的医生

执行完成后，刷新前端页面即可看到医生列表！

